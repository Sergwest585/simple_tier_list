<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
  
  <title>editor</title>
  <meta charset="utf-8">
  <style>
    body {
      font-family: "Rubik", sans-serif;
      font-optical-sizing: auto;
      font-weight: 600;
      font-style: normal;
      margin: 2px;
      background-color: rgb(40, 40, 40);
      color: white;
    }
    table {
      border: 2px solid rgb(60, 60, 60);
      border-collapse: collapse;
    }
    table tr {
      display: flex;
      min-height: 102px;
      border: 2px solid rgb(60, 60, 60);
    }
    button {
      border: none;
      text-align: center;
      text-decoration: none;
      min-height: 102px;
      margin: 0 1px 0 1px;
    }
    input {
      font-size: 32px;
    }
    input[type=color] {
      width: 32px;
    }
    .tier_head {
      border-right: 2px solid rgb(60, 60, 60);
      width: 100px;
      min-height: 102px;
      align-content: center;
      display: block !important;
      word-wrap: break-word;
      text-align: center;
      text-wrap: balance;
      /* font-size: 50px; */
    }
    .tier_body {
      min-width: 102px;
      display: flex;
      flex-wrap: wrap;
      flex-grow: 1;
      min-height: 102px;
      background-color: rgb(40, 40, 40);
    }
    #controll_buttons div {
      align-content: center;
      justify-content: center;
      display: flex;
      flex-wrap: wrap;
      border: 2px solid rgb(60, 60, 60);
      width: 100px;
      height: 100px;
    }
    #controll_buttons div:not([id="trash_element"]):hover {
      background-color: rgb(70, 65, 35);
    }
    .add_button {
      align-content: center;
      justify-content: center;
      display: flex;
      flex-wrap: wrap;
      border-right: 2px solid rgb(60, 60, 60);
      background-color: rgb(65, 65, 65);
      width: 40px;
    }
    .add_button:hover {
      background-color: rgb(70, 65, 35);
    }
  </style>
</head>
<body>
  <table id="main_table">
  </table>
  <div style="display: flex;" id="controll_buttons">
    <div id="trash_element">
      trash
    </div>
    <div onclick="add_new_tier('?', 'rgb(30, 30, 30)')">
      new tier
    </div>
    <div onclick="save_as_image()">
      download
    </div>
    <div onclick="save_tierlist()">
      save
    </div>
    <div onclick="load_tierlist()">
      load
    </div>
  </div>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    var main_table = document.getElementById("main_table");
    const start_elements_strings = ["S", "A", "B", "C", "D", "F"];
    const start_elements_count = start_elements_strings.length;
    //var db;

    function download_file(data, filename) {
      let a = document.createElement("a");
      a.href = data;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function() {
        document.body.removeChild(a);
      }, 0);
    }
    
    function download_text_file(data, filename) {
      const blob = new Blob([data], {type: 'text/csv'});
      let a = document.createElement("a");
      a.href = window.URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function() {
        document.body.removeChild(a);
      }, 0);
    }
  
    function load_text(onchange_func) {
      const file_selector = document.createElement('input');
      file_selector.setAttribute('type', 'file');
      file_selector.setAttribute('accept','text');
      file_selector.onchange = onchange_func;
      file_selector.click();
    }

    function save_tierlist() {
      var saved = ""

      let tiers = document.getElementsByTagName("tr")

      for (let i = 0; i < tiers.length; i++) {
        let tier_head = tiers[i].firstChild;
        let tier_body = tiers[i].lastChild;
        saved += tier_head.innerHTML;
        saved += "|";
        saved += window.getComputedStyle(tier_head).getPropertyValue("background-color");
        saved += "|";
        saved += window.getComputedStyle(tier_head).getPropertyValue("color");
        for (let j = 0; j < tier_body.children.length; j++) {
          saved += "|";
          saved += tier_body.children[j].src;
        }
        saved += ";;"
      }

      download_text_file(saved, "tierlist.txt");
    }

    function load_tierlist() {
      load_text(function(e){
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.addEventListener('load', (event) => {
          let elements = document.getElementsByTagName("tr");
          for (;elements.length;) {
            elements[0].remove();
          }
          let savefile = reader.result;
          let tier_saves = savefile.split(";;");
          for (let i = 0; i < tier_saves.length-1; i++) {
            let tier_data_saves = tier_saves[i].split("|");
            let new_tier = add_new_tier(tier_data_saves[0], tier_data_saves[1], tier_data_saves[2]);
            for (let j = 3; j < tier_data_saves.length; j++) {
              add_image(new_tier.lastChild, tier_data_saves[j]);
            }
          }
        });
        reader.readAsText(file);
      });
    }
    
    function save_as_image() {
      let btns = document.getElementsByTagName('button');
      for (const btn of btns) {
        btn.style.display = 'none'
      }
      html2canvas(main_table).then(canvas => {
        let dataURL = canvas.toDataURL();
        download_file(dataURL, 'tierlist.png');
      });
      for (const btn of btns) {
        btn.style.display = 'block'
      };
    }

    function rgbToHex(col) {
      col=col.replace('rgb(','').replace(')','').split(',');
      var r=parseInt(col[0], 10).toString(16);
      var g=parseInt(col[1], 10).toString(16);
      var b=parseInt(col[2], 10).toString(16);
      r=r.length==1?'0'+r:r; g=g.length==1?'0'+g:g; b=b.length==1?'0'+b:b;
      var colHex='#'+r+g+b;
      return colHex;
    }
  
  
    function dragstartHandler(ev) {
      ev.target.id = "_now_draged";
      ev.dataTransfer.setData("application/my-app", ev.target.id);
      ev.dataTransfer.effectAllowed = "move";
    }
    function dragoverHandler(ev) {
      ev.preventDefault();
      ev.dataTransfer.dropEffect = "move";
    }
    function dropHandler(ev) {
      ev.preventDefault();
      const element_droped = document.getElementById(ev.dataTransfer.getData("application/my-app"));
      if (ev.target.tagName == "DIV") {
        ev.target.appendChild(element_droped);
      } else {
        ev.target.insertAdjacentElement("beforebegin", element_droped);
      }
      element_droped.id = ""
    }
    function trashHandler(ev) {
      ev.preventDefault();
      const element_droped = document.getElementById(ev.dataTransfer.getData("application/my-app"));
      element_droped.remove()
    }
  
    function load_texture(onchange_func) {
      const file_selector = document.createElement('input');
      file_selector.setAttribute('type', 'file');
      file_selector.setAttribute('accept','image'); 
      file_selector.setAttribute('multiple','multiple');
      file_selector.onchange = onchange_func;
      file_selector.click();
    }
    
    function add_image(element_to, data) {
      let new_image = new Image();
      new_image.src = data;
      new_image.draggable=true;
      new_image.style.height = 100+"px";
      new_image.style.padding = "1px 1px 1px 1px"
      new_image.ondragstart = dragstartHandler;
      element_to.appendChild(new_image);
    }

    function add_new_image(element_to) {
      load_texture(function(e) {
        const files = e.target.files;
        for (const file of files){
          const reader = new FileReader();
          reader.addEventListener('load', (event) => {
            add_image(element_to, reader.result);
          });
          reader.readAsDataURL(file);
        }
      })
    }
  
    function add_new_tier(tier_text, tier_color, tier_text_color) {
      let new_tier = document.createElement("tr");
  
      let new_tier_head = document.createElement("div");
      new_tier_head.style.fontSize = 50+"px";
  
      new_tier_head.style.backgroundColor = tier_color;
      new_tier_head.style.color = tier_text_color;
      new_tier_head.classList.add("tier_head");
      new_tier_head.innerHTML = tier_text;
      new_tier_head.onclick = function() {
        let func_now = new_tier_head.onclick;
        new_tier_head.onclick = null;
  
        let color_container = document.createElement("div");
        let text_input = document.createElement("input");
        let bg_color_input = document.createElement("input");
        let color_input = document.createElement("input");
        let controll_container = document.createElement("div");
        let delete_button = document.createElement("input");
        let set_button = document.createElement("input");
  
        color_container.style.display = "flex";
        controll_container.style.display = "flex";
        
        text_input.type = "text";
        bg_color_input.type = "color";
        color_input.type = "color";
  
        text_input.value = new_tier_head.innerHTML;
        bg_color_input.value = rgbToHex(window.getComputedStyle(new_tier_head).getPropertyValue("background-color"));
        color_input.value = rgbToHex(window.getComputedStyle(new_tier_head).getPropertyValue("color"));
  
        text_input.size = text_input.value.length+1;
        
        text_input.oninput = function() {
          text_input.size = (text_input.value.length+1);
        }

        function set_style(text) {
          new_tier_head.innerHTML = text;
          new_tier_head.style.backgroundColor = bg_color_input.value;
          new_tier_head.style.color = color_input.value;
          new_tier_head.style.display = "flex";
          new_tier_head.style.fontSize = 50/(text.length ** 0.4)+"px";
          new_tier_head.onclick = func_now;
        }

        text_input.onkeyup = function(e) {
          if (e.keyCode === 13) {
            set_style(text_input.value);
          }
          e.preventDefault();
        };

        delete_button.type = "button";
        delete_button.onclick = function() {
          new_tier.remove();
        }
        delete_button.value = "X"
        delete_button.style.width = 20+"px"
        delete_button.style.height = 20+"px"
        delete_button.style.fontSize = 14+"px"

        set_button.type = "button";
        set_button.onclick = function() {
          setTimeout(() => {
            set_style(text_input.value);
          }, 0);
        }
        set_button.value = "âœ“"
        set_button.style.width = 20+"px"
        set_button.style.height = 20+"px"
        set_button.style.fontSize = 14+"px"
  
        new_tier_head.innerHTML = '';
        new_tier_head.style.display = "grid";
        color_container.appendChild(color_input);
        color_container.appendChild(bg_color_input);
        new_tier_head.appendChild(color_container);
        new_tier_head.appendChild(text_input);
        controll_container.appendChild(delete_button);
        controll_container.appendChild(set_button);
        new_tier_head.appendChild(controll_container);
      }
  
      let new_tier_body = document.createElement("div");
      new_tier_body.ondragover = dragoverHandler;
      new_tier_body.ondrop = dropHandler;
      new_tier_body.classList.add("tier_body");
  
      let new_addbutton = document.createElement("div");
      new_addbutton.classList.add("add_button");
      new_addbutton.innerHTML = "Add";
      new_addbutton.onclick = function() {
        add_new_image(new_tier_body);
      }

      new_tier.addEventListener('paste', (e) => {
        const items = event.clipboardData.items;

        for (let i = 0; i < items.length; i++) {
          if (items[i].kind === 'file' && items[i].type.startsWith('image/')) {
            add_image(new_tier_body, URL.createObjectURL(items[i].getAsFile()));
          } else if (items[i].kind === 'string' && items[i].type === 'text/plain') {
            items[i].getAsString((s) => {
              add_image(new_tier_body, s);
            });
          }
        }
      });
  
      new_tier.appendChild(new_tier_head);
      new_tier.appendChild(new_addbutton);
      new_tier.appendChild(new_tier_body);
      main_table.appendChild(new_tier);
      return new_tier;
    }
  
    (function main() {
      /*const request = indexedDB.open("Sergwest_simple_tier_list");
      request.onerror = (event) => {
        console.error("Why didn't you allow my web app to use IndexedDB?!");
      };
      request.onsuccess = (event) => {
        db = event.target.result;
      };
      db.onerror = (event) => {
        console.error(`Database error: ${event.target.errorCode}`);
      };*/
      for (let iter = 0; iter < start_elements_count; iter++) {
        add_new_tier(start_elements_strings[iter], "hsl(" + (360 * iter / start_elements_count) + ",60%,50%)", "rgb(255,255,255)");
      }
      trash_element.ondragover = dragoverHandler;
      trash_element.ondrop = trashHandler;
    })();
  </script>
</body>
</html>